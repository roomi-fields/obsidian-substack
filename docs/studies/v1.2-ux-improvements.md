# Étude v1.2.0 - Améliorations UX

**Version**: 1.2.0
**Priorité**: MOYENNE
**Statut**: À développer
**Dépendance**: v1.1.0 (Images)

---

## 1. Contexte et Objectifs

### 1.1 Problème
La v1.0-1.1 offre les fonctionnalités de base mais manque de polish UX :
- Pas de sélection d'audience (paywall)
- Pas de feedback après publication (lien vers le post)
- Gestion d'erreurs basique
- Pas de confirmation avant publication

### 1.2 Objectifs
- Améliorer l'expérience utilisateur du modal de publication
- Ajouter le contrôle d'audience (free/paid)
- Fournir un feedback riche après publication
- Gestion d'erreurs informative

### 1.3 Critères de succès
- Utilisateur peut choisir l'audience sans éditer le frontmatter
- Lien cliquable vers le post après publication
- Messages d'erreur actionnables
- Réduction des erreurs utilisateur

---

## 2. Analyse Fonctionnelle (BRD)

### 2.1 User Stories

| ID | Story | Priorité |
|----|-------|----------|
| US-1 | En tant qu'auteur, je veux choisir si mon post est gratuit ou payant | MUST |
| US-2 | En tant qu'auteur, je veux une confirmation avant de publier directement | SHOULD |
| US-3 | En tant qu'auteur, je veux le lien vers mon post après publication | MUST |
| US-4 | En tant qu'auteur, je veux comprendre pourquoi une publication a échoué | MUST |
| US-5 | En tant qu'auteur, je veux voir un indicateur de progression | SHOULD |
| US-6 | En tant qu'auteur, je veux pouvoir annuler pendant l'upload | COULD |

### 2.2 Sélecteur d'audience

**Options disponibles** (API Substack):
| Valeur | Label UI | Description |
|--------|----------|-------------|
| `everyone` | Everyone | Visible par tous |
| `only_free` | Free subscribers | Abonnés gratuits uniquement |
| `only_paid` | Paid subscribers | Abonnés payants uniquement |
| `founding` | Founding members | Membres fondateurs uniquement |

**Comportement par défaut**: `everyone`

### 2.3 Confirmation de publication

Modal de confirmation avant `Publish` (pas pour Draft):
```
┌─────────────────────────────────────────┐
│  Publish to Substack?                   │
│                                         │
│  Title: Mon article                     │
│  Publication: mypub                     │
│  Audience: Paid subscribers             │
│                                         │
│  This will immediately publish your     │
│  post to all selected subscribers.      │
│                                         │
│  [Cancel]              [Publish Now]    │
└─────────────────────────────────────────┘
```

### 2.4 Feedback post-publication

**Succès Draft**:
```
┌─────────────────────────────────────────┐
│  ✓ Draft saved successfully!            │
│                                         │
│  [Open in Substack]    [Close]          │
└─────────────────────────────────────────┘
```

**Succès Publish**:
```
┌─────────────────────────────────────────┐
│  ✓ Published successfully!              │
│                                         │
│  Your post is now live at:              │
│  https://mypub.substack.com/p/slug      │
│                                         │
│  [Open Post]  [Copy Link]  [Close]      │
└─────────────────────────────────────────┘
```

### 2.5 Messages d'erreur

| Code erreur | Message | Action suggérée |
|-------------|---------|-----------------|
| 401 | Session expired | "Please update your Substack cookie in settings" |
| 403 | Not authorized | "You don't have permission to publish to this publication" |
| 404 | Publication not found | "Publication '{name}' not found. Check the name in settings" |
| 429 | Rate limited | "Too many requests. Please wait a moment and try again" |
| 500 | Server error | "Substack is having issues. Please try again later" |
| Network | Connection failed | "Could not connect to Substack. Check your internet connection" |

---

## 3. Spécifications Techniques (CPD)

### 3.1 Modification du Modal PostComposer

**Nouveaux éléments UI**:

```typescript
// Ajouts dans onOpen()

// Audience selector (après subtitle)
const audienceContainer = contentEl.createDiv({ cls: "substack-field-container" });
audienceContainer.createEl("label", { text: "Audience" });
const audienceSelect = audienceContainer.createEl("select", { cls: "substack-select" });

const audiences = [
  { value: "everyone", label: "Everyone" },
  { value: "only_free", label: "Free subscribers only" },
  { value: "only_paid", label: "Paid subscribers only" },
  { value: "founding", label: "Founding members only" },
];

for (const aud of audiences) {
  audienceSelect.createEl("option", { text: aud.label, value: aud.value });
}
```

### 3.2 Composant ConfirmationModal

```typescript
// src/substack/ConfirmationModal.ts

import { App, Modal } from "obsidian";

export interface ConfirmationOptions {
  title: string;
  publication: string;
  audience: string;
  onConfirm: () => void;
  onCancel: () => void;
}

export class ConfirmationModal extends Modal {
  private options: ConfirmationOptions;

  constructor(app: App, options: ConfirmationOptions) {
    super(app);
    this.options = options;
  }

  onOpen() {
    const { contentEl } = this;
    contentEl.addClass("substack-confirmation-modal");

    contentEl.createEl("h3", { text: "Publish to Substack?" });

    const details = contentEl.createDiv({ cls: "substack-confirmation-details" });
    details.createEl("p", { text: `Title: ${this.options.title}` });
    details.createEl("p", { text: `Publication: ${this.options.publication}` });
    details.createEl("p", { text: `Audience: ${this.options.audience}` });

    contentEl.createEl("p", {
      text: "This will immediately publish your post to all selected subscribers.",
      cls: "substack-confirmation-warning"
    });

    const buttons = contentEl.createDiv({ cls: "substack-button-container" });

    buttons.createEl("button", { text: "Cancel", cls: "substack-cancel-button" })
      .addEventListener("click", () => {
        this.options.onCancel();
        this.close();
      });

    buttons.createEl("button", { text: "Publish Now", cls: "substack-publish-button" })
      .addEventListener("click", () => {
        this.options.onConfirm();
        this.close();
      });
  }
}
```

### 3.3 Composant SuccessModal

```typescript
// src/substack/SuccessModal.ts

import { App, Modal } from "obsidian";

export interface SuccessOptions {
  type: "draft" | "publish";
  postUrl?: string;
  draftUrl?: string;
}

export class SuccessModal extends Modal {
  private options: SuccessOptions;

  constructor(app: App, options: SuccessOptions) {
    super(app);
    this.options = options;
  }

  onOpen() {
    const { contentEl } = this;
    contentEl.addClass("substack-success-modal");

    if (this.options.type === "draft") {
      contentEl.createEl("h3", { text: "✓ Draft saved successfully!" });

      const buttons = contentEl.createDiv({ cls: "substack-button-container" });

      if (this.options.draftUrl) {
        buttons.createEl("button", { text: "Open in Substack" })
          .addEventListener("click", () => {
            window.open(this.options.draftUrl, "_blank");
          });
      }

      buttons.createEl("button", { text: "Close" })
        .addEventListener("click", () => this.close());

    } else {
      contentEl.createEl("h3", { text: "✓ Published successfully!" });

      if (this.options.postUrl) {
        contentEl.createEl("p", { text: "Your post is now live at:" });
        const link = contentEl.createEl("a", {
          text: this.options.postUrl,
          href: this.options.postUrl,
        });
        link.setAttr("target", "_blank");
      }

      const buttons = contentEl.createDiv({ cls: "substack-button-container" });

      buttons.createEl("button", { text: "Open Post" })
        .addEventListener("click", () => {
          window.open(this.options.postUrl, "_blank");
        });

      buttons.createEl("button", { text: "Copy Link" })
        .addEventListener("click", () => {
          navigator.clipboard.writeText(this.options.postUrl || "");
          // Show toast "Link copied!"
        });

      buttons.createEl("button", { text: "Close" })
        .addEventListener("click", () => this.close());
    }
  }
}
```

### 3.4 Classe ErrorHandler

```typescript
// src/substack/errorHandler.ts

export interface SubstackError {
  code: number | string;
  message: string;
  action: string;
}

export function parseSubstackError(error: unknown): SubstackError {
  if (error instanceof Error) {
    // Parse HTTP status codes
    const statusMatch = error.message.match(/status[:\s]+(\d+)/i);
    if (statusMatch) {
      const status = parseInt(statusMatch[1]);
      return getErrorByStatus(status);
    }

    // Network errors
    if (error.message.includes("network") || error.message.includes("fetch")) {
      return {
        code: "NETWORK",
        message: "Could not connect to Substack",
        action: "Check your internet connection and try again"
      };
    }
  }

  return {
    code: "UNKNOWN",
    message: "An unexpected error occurred",
    action: "Please try again. If the problem persists, check your settings"
  };
}

function getErrorByStatus(status: number): SubstackError {
  const errors: Record<number, SubstackError> = {
    401: {
      code: 401,
      message: "Session expired",
      action: "Please update your Substack cookie in settings"
    },
    403: {
      code: 403,
      message: "Not authorized",
      action: "You don't have permission to publish to this publication"
    },
    404: {
      code: 404,
      message: "Publication not found",
      action: "Check the publication name in settings"
    },
    429: {
      code: 429,
      message: "Rate limited",
      action: "Too many requests. Please wait a moment and try again"
    },
    500: {
      code: 500,
      message: "Substack server error",
      action: "Substack is having issues. Please try again later"
    }
  };

  return errors[status] || {
    code: status,
    message: `HTTP error ${status}`,
    action: "Please try again"
  };
}
```

### 3.5 Progress Indicator

```typescript
// Dans PostComposer.ts

private progressContainer: HTMLElement | null = null;
private progressBar: HTMLElement | null = null;
private progressText: HTMLElement | null = null;

private showProgress(message: string, percent: number = 0) {
  if (!this.progressContainer) {
    this.progressContainer = this.contentEl.createDiv({ cls: "substack-progress" });
    this.progressBar = this.progressContainer.createDiv({ cls: "substack-progress-bar" });
    this.progressText = this.progressContainer.createDiv({ cls: "substack-progress-text" });
  }

  this.progressBar!.style.width = `${percent}%`;
  this.progressText!.textContent = message;
  this.progressContainer!.style.display = "block";
}

private hideProgress() {
  if (this.progressContainer) {
    this.progressContainer.style.display = "none";
  }
}
```

---

## 4. Architecture Logicielle

### 4.1 Nouveaux composants

```
src/substack/
├── api.ts                 (existant)
├── types.ts               (existant)
├── converter.ts           (existant)
├── PostComposer.ts        (modifié)
├── ConfirmationModal.ts   (nouveau)
├── SuccessModal.ts        (nouveau)
└── errorHandler.ts        (nouveau)
```

### 4.2 Flux de publication avec UX améliorée

```
┌─────────────────────────────────────────────────────────────┐
│                     PostComposer                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ [Publication ▼] [Title] [Subtitle] [Audience ▼]         ││
│  │ [Preview]                                                ││
│  │ [Progress: Uploading images... 50%]                     ││
│  │ [Cancel] [Save Draft] [Publish]                         ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
           │                              │
           │ Draft                        │ Publish
           ▼                              ▼
    ┌──────────────┐            ┌──────────────────┐
    │ Processing   │            │ ConfirmationModal│
    │ ...          │            │ "Are you sure?"  │
    └──────┬───────┘            └────────┬─────────┘
           │                             │ Confirm
           ▼                             ▼
    ┌──────────────┐            ┌──────────────────┐
    │ SuccessModal │            │ Processing       │
    │ "Draft saved"│            │ ...              │
    └──────────────┘            └────────┬─────────┘
                                         │
                                         ▼
                                ┌──────────────────┐
                                │ SuccessModal     │
                                │ "Published!"     │
                                │ [Open] [Copy]    │
                                └──────────────────┘
```

### 4.3 Styles CSS additionnels

```css
/* styles.css - Ajouts v1.2 */

/* Progress bar */
.substack-progress {
  margin: 1rem 0;
  display: none;
}

.substack-progress-bar {
  height: 4px;
  background: var(--interactive-accent);
  border-radius: 2px;
  transition: width 0.3s ease;
}

.substack-progress-text {
  font-size: 0.85em;
  color: var(--text-muted);
  margin-top: 0.5rem;
}

/* Confirmation modal */
.substack-confirmation-modal {
  max-width: 400px;
}

.substack-confirmation-details {
  background: var(--background-secondary);
  padding: 1rem;
  border-radius: 4px;
  margin: 1rem 0;
}

.substack-confirmation-details p {
  margin: 0.25rem 0;
}

.substack-confirmation-warning {
  color: var(--text-muted);
  font-size: 0.9em;
}

/* Success modal */
.substack-success-modal h3 {
  color: var(--text-success);
}

.substack-success-modal a {
  word-break: break-all;
  color: var(--text-accent);
}
```

---

## 5. Plan d'implémentation

### 5.1 Tâches

| # | Tâche | Estimation | Dépendances |
|---|-------|------------|-------------|
| 1 | Ajouter audience selector dans PostComposer | 1h | - |
| 2 | Créer `errorHandler.ts` | 1h | - |
| 3 | Créer `ConfirmationModal.ts` | 1h | - |
| 4 | Créer `SuccessModal.ts` | 1.5h | - |
| 5 | Intégrer confirmation dans flux Publish | 1h | 3 |
| 6 | Intégrer success modal dans flux | 1h | 4 |
| 7 | Améliorer gestion erreurs dans PostComposer | 1h | 2 |
| 8 | Ajouter progress indicator | 1h | - |
| 9 | Styles CSS pour nouveaux composants | 1h | 3, 4, 8 |
| 10 | Tests manuels | 1h | tout |

**Total estimé**: ~11h

### 5.2 Fichiers à créer/modifier

**Nouveaux fichiers**:
- `src/substack/ConfirmationModal.ts`
- `src/substack/SuccessModal.ts`
- `src/substack/errorHandler.ts`

**Fichiers modifiés**:
- `src/substack/PostComposer.ts`
- `src/substack/api.ts` (récupérer URL post)
- `styles.css`

---

## 6. Critères d'acceptance

- [ ] Sélecteur d'audience fonctionnel (4 options)
- [ ] Modal de confirmation avant Publish
- [ ] Modal de succès avec lien vers le post
- [ ] Bouton "Copy Link" fonctionnel
- [ ] Messages d'erreur clairs pour codes HTTP courants
- [ ] Progress bar pendant l'upload
- [ ] Tous les nouveaux éléments stylés correctement

---

## 7. Références

- [Obsidian Modal API](https://docs.obsidian.md/Reference/TypeScript+API/Modal)
- [Obsidian Notice API](https://docs.obsidian.md/Reference/TypeScript+API/Notice)
