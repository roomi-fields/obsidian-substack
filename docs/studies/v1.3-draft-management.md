# Étude v1.3.0 - Gestion des Drafts

**Version**: 1.3.0
**Priorité**: MOYENNE
**Statut**: À développer
**Dépendances**: v1.1.0, v1.2.0

---

## 1. Contexte et Objectifs

### 1.1 Problème
La v1.0-1.2 crée toujours un nouveau draft à chaque publication. Les utilisateurs qui itèrent sur un article créent des drafts en double. Pas de visibilité sur les drafts existants ni possibilité de les mettre à jour.

### 1.2 Objectifs
- Lister les drafts existants d'une publication
- Mettre à jour un draft existant au lieu d'en créer un nouveau
- Supprimer des drafts obsolètes
- Lier une note Obsidian à un draft Substack (optionnel)

### 1.3 Critères de succès
- Vue des drafts existants dans le modal
- Mise à jour sans duplication
- Suppression sécurisée (confirmation)
- Synchronisation note ↔ draft (optionnel)

---

## 2. Analyse Fonctionnelle (BRD)

### 2.1 User Stories

| ID | Story | Priorité |
|----|-------|----------|
| US-1 | En tant qu'auteur, je veux voir mes drafts existants | MUST |
| US-2 | En tant qu'auteur, je veux mettre à jour un draft existant | MUST |
| US-3 | En tant qu'auteur, je veux supprimer un draft | SHOULD |
| US-4 | En tant qu'auteur, je veux que ma note soit liée à son draft | COULD |
| US-5 | En tant qu'auteur, je veux filtrer/chercher mes drafts | COULD |
| US-6 | En tant qu'auteur, je veux voir la date de dernière modification | SHOULD |

### 2.2 Liste des drafts

**Informations affichées par draft**:
- Titre
- Subtitle (si présent)
- Date de création
- Date de dernière modification
- Statut (draft/scheduled)

**Actions disponibles**:
- Mettre à jour avec la note actuelle
- Ouvrir dans Substack (navigateur)
- Supprimer

### 2.3 Liaison Note ↔ Draft

**Via frontmatter YAML**:
```yaml
---
title: Mon article
substack:
  draft_id: "12345678"
  publication: "mypub"
  last_sync: "2025-01-15T10:30:00Z"
---
```

**Comportement**:
- Si `draft_id` présent → proposer "Update existing draft"
- Si absent → créer nouveau draft
- Après création → proposer d'ajouter `draft_id` au frontmatter

### 2.4 Modes de publication

```
┌─────────────────────────────────────────┐
│  Publish to Substack                    │
│                                         │
│  ○ Create new draft                     │
│  ● Update existing draft                │
│    └─ [Select draft ▼]                  │
│                                         │
│  [Draft list below...]                  │
└─────────────────────────────────────────┘
```

---

## 3. Spécifications Techniques (CPD)

### 3.1 API Substack - Drafts

**List Drafts**:
```
GET https://{publication}.substack.com/api/v1/drafts
Cookie: {session}

Response:
[
  {
    "id": "12345",
    "draft_title": "Mon article",
    "draft_subtitle": "Sous-titre",
    "draft_created_at": "2025-01-10T...",
    "draft_updated_at": "2025-01-15T...",
    "audience": "everyone",
    "type": "newsletter"
  },
  ...
]
```

**Get Draft**:
```
GET https://{publication}.substack.com/api/v1/drafts/{id}
```

**Update Draft**:
```
PUT https://{publication}.substack.com/api/v1/drafts/{id}
Body: {
  "draft_title": "...",
  "draft_subtitle": "...",
  "draft_body": {...}
}
```

**Delete Draft**:
```
DELETE https://{publication}.substack.com/api/v1/drafts/{id}
```

### 3.2 Nouvelles interfaces TypeScript

```typescript
// src/substack/types.ts - Ajouts

export interface SubstackDraftListItem {
  id: string;
  draft_title: string;
  draft_subtitle: string;
  draft_created_at: string;
  draft_updated_at: string;
  audience: string;
  type: string;
  slug?: string;
}

export interface NoteFrontmatter {
  title?: string;
  subtitle?: string;
  substack?: {
    draft_id?: string;
    publication?: string;
    last_sync?: string;
  };
}

export interface DraftLinkInfo {
  draftId: string;
  publication: string;
  lastSync: Date;
}
```

### 3.3 Classe DraftManager

```typescript
// src/substack/draftManager.ts

import { App, TFile } from "obsidian";
import { SubstackAPI } from "./api";
import { SubstackDraftListItem, DraftLinkInfo, NoteFrontmatter } from "./types";

export class DraftManager {
  private api: SubstackAPI;
  private app: App;

  constructor(api: SubstackAPI, app: App) {
    this.api = api;
    this.app = app;
  }

  /**
   * Liste les drafts d'une publication
   */
  async listDrafts(publication: string): Promise<SubstackDraftListItem[]> {
    const response = await this.api.listDrafts(publication);
    return response.json as SubstackDraftListItem[];
  }

  /**
   * Met à jour un draft existant
   */
  async updateDraft(
    publication: string,
    draftId: string,
    title: string,
    body: SubstackDocument,
    subtitle?: string
  ): Promise<void> {
    await this.api.updateDraft(publication, draftId, {
      title,
      subtitle,
      body,
    });
  }

  /**
   * Supprime un draft
   */
  async deleteDraft(publication: string, draftId: string): Promise<void> {
    await this.api.deleteDraft(publication, draftId);
  }

  /**
   * Récupère le lien draft depuis le frontmatter d'une note
   */
  getDraftLinkFromNote(file: TFile): DraftLinkInfo | null {
    const cache = this.app.metadataCache.getFileCache(file);
    const frontmatter = cache?.frontmatter as NoteFrontmatter | undefined;

    if (frontmatter?.substack?.draft_id) {
      return {
        draftId: frontmatter.substack.draft_id,
        publication: frontmatter.substack.publication || "",
        lastSync: frontmatter.substack.last_sync
          ? new Date(frontmatter.substack.last_sync)
          : new Date(0),
      };
    }
    return null;
  }

  /**
   * Met à jour le frontmatter avec l'ID du draft
   */
  async linkDraftToNote(
    file: TFile,
    draftId: string,
    publication: string
  ): Promise<void> {
    const content = await this.app.vault.read(file);
    const now = new Date().toISOString();

    // Parser et mettre à jour le frontmatter
    const frontmatterRegex = /^---\n([\s\S]*?)\n---/;
    const match = content.match(frontmatterRegex);

    let newContent: string;

    if (match) {
      // Frontmatter existe - mettre à jour
      let frontmatter = match[1];

      if (frontmatter.includes("substack:")) {
        // Mettre à jour section existante
        frontmatter = frontmatter.replace(
          /substack:[\s\S]*?(?=\n\w|\n---)/,
          `substack:\n  draft_id: "${draftId}"\n  publication: "${publication}"\n  last_sync: "${now}"\n`
        );
      } else {
        // Ajouter section substack
        frontmatter += `\nsubstack:\n  draft_id: "${draftId}"\n  publication: "${publication}"\n  last_sync: "${now}"`;
      }

      newContent = content.replace(frontmatterRegex, `---\n${frontmatter}\n---`);
    } else {
      // Pas de frontmatter - en créer un
      const newFrontmatter = `---
substack:
  draft_id: "${draftId}"
  publication: "${publication}"
  last_sync: "${now}"
---

`;
      newContent = newFrontmatter + content;
    }

    await this.app.vault.modify(file, newContent);
  }
}
```

### 3.4 Composant DraftListModal

```typescript
// src/substack/DraftListModal.ts

import { App, Modal } from "obsidian";
import { SubstackDraftListItem } from "./types";

export interface DraftListOptions {
  drafts: SubstackDraftListItem[];
  onSelect: (draft: SubstackDraftListItem) => void;
  onDelete: (draft: SubstackDraftListItem) => void;
  onOpenInBrowser: (draft: SubstackDraftListItem) => void;
}

export class DraftListModal extends Modal {
  private options: DraftListOptions;

  constructor(app: App, options: DraftListOptions) {
    super(app);
    this.options = options;
  }

  onOpen() {
    const { contentEl } = this;
    contentEl.addClass("substack-draft-list-modal");

    contentEl.createEl("h2", { text: "Select a draft to update" });

    if (this.options.drafts.length === 0) {
      contentEl.createEl("p", {
        text: "No drafts found for this publication.",
        cls: "substack-no-drafts"
      });
      return;
    }

    const list = contentEl.createEl("div", { cls: "substack-draft-list" });

    for (const draft of this.options.drafts) {
      const item = list.createEl("div", { cls: "substack-draft-item" });

      const info = item.createEl("div", { cls: "substack-draft-info" });
      info.createEl("div", {
        text: draft.draft_title || "Untitled",
        cls: "substack-draft-title"
      });

      if (draft.draft_subtitle) {
        info.createEl("div", {
          text: draft.draft_subtitle,
          cls: "substack-draft-subtitle"
        });
      }

      const date = new Date(draft.draft_updated_at);
      info.createEl("div", {
        text: `Updated: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`,
        cls: "substack-draft-date"
      });

      const actions = item.createEl("div", { cls: "substack-draft-actions" });

      actions.createEl("button", { text: "Select" })
        .addEventListener("click", () => {
          this.options.onSelect(draft);
          this.close();
        });

      actions.createEl("button", { text: "Open" })
        .addEventListener("click", () => {
          this.options.onOpenInBrowser(draft);
        });

      actions.createEl("button", { text: "Delete", cls: "substack-danger-button" })
        .addEventListener("click", () => {
          if (confirm(`Delete draft "${draft.draft_title}"?`)) {
            this.options.onDelete(draft);
            item.remove();
          }
        });
    }
  }
}
```

### 3.5 Modifications PostComposer

```typescript
// Ajouts dans PostComposer.ts

private draftManager: DraftManager;
private selectedDraft: SubstackDraftListItem | null = null;
private mode: "create" | "update" = "create";

// Dans constructor
this.draftManager = new DraftManager(api, app);

// Dans onOpen - Ajouter section mode
private renderModeSelector() {
  const modeContainer = this.contentEl.createDiv({ cls: "substack-mode-container" });

  const createRadio = modeContainer.createEl("input", {
    type: "radio",
    attr: { name: "mode", value: "create", checked: true }
  });
  modeContainer.createEl("label", { text: "Create new draft" });

  const updateRadio = modeContainer.createEl("input", {
    type: "radio",
    attr: { name: "mode", value: "update" }
  });
  modeContainer.createEl("label", { text: "Update existing draft" });

  const draftSelector = modeContainer.createDiv({ cls: "substack-draft-selector" });
  draftSelector.style.display = "none";

  const selectButton = draftSelector.createEl("button", {
    text: "Select draft..."
  });

  selectButton.addEventListener("click", async () => {
    await this.showDraftList();
  });

  createRadio.addEventListener("change", () => {
    this.mode = "create";
    this.selectedDraft = null;
    draftSelector.style.display = "none";
  });

  updateRadio.addEventListener("change", () => {
    this.mode = "update";
    draftSelector.style.display = "block";
  });
}

private async showDraftList() {
  const drafts = await this.draftManager.listDrafts(this.selectedPublication);

  const modal = new DraftListModal(this.app, {
    drafts,
    onSelect: (draft) => {
      this.selectedDraft = draft;
      // Update UI to show selected draft
    },
    onDelete: async (draft) => {
      await this.draftManager.deleteDraft(this.selectedPublication, draft.id);
    },
    onOpenInBrowser: (draft) => {
      const url = `https://${this.selectedPublication}.substack.com/publish/post/${draft.id}`;
      window.open(url, "_blank");
    },
  });

  modal.open();
}

// Modifier saveDraft pour supporter update
private async saveDraft() {
  // ... validation ...

  if (this.mode === "update" && this.selectedDraft) {
    await this.draftManager.updateDraft(
      this.selectedPublication,
      this.selectedDraft.id,
      this.title,
      body,
      this.subtitle
    );
  } else {
    const response = await this.api.createDraft(...);
    // Proposer de lier le draft à la note
  }
}
```

---

## 4. Architecture Logicielle

### 4.1 Diagramme de composants

```
┌─────────────────────────────────────────────────────────────┐
│                     PostComposer.ts                          │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Mode: ○ Create new  ● Update existing                  │ │
│  │       └─ [Selected: "Mon article" ▼]                   │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
         │                              │
         │ Select draft                 │ Save/Publish
         ▼                              ▼
┌─────────────────────┐        ┌─────────────────────┐
│  DraftListModal     │        │  DraftManager       │
│  - Liste des drafts │        │  - listDrafts()     │
│  - Select/Delete    │        │  - updateDraft()    │
│  - Open in browser  │        │  - deleteDraft()    │
└─────────────────────┘        │  - linkDraftToNote()│
                               └──────────┬──────────┘
                                          │
                                          ▼
                               ┌─────────────────────┐
                               │   SubstackAPI       │
                               │   - GET /drafts     │
                               │   - PUT /drafts/:id │
                               │   - DELETE /:id     │
                               └─────────────────────┘
```

### 4.2 Flux Update Draft

```
User            PostComposer       DraftManager        API
  │                  │                  │               │
  │─Select Update───►│                  │               │
  │                  │─listDrafts()────►│               │
  │                  │                  │─GET /drafts──►│
  │                  │◄─────────────────│◄──────────────│
  │                  │                  │               │
  │◄──DraftListModal─│                  │               │
  │                  │                  │               │
  │─Select draft────►│                  │               │
  │                  │                  │               │
  │─Save Draft──────►│                  │               │
  │                  │─updateDraft()───►│               │
  │                  │                  │─PUT /drafts/id►
  │                  │◄─────────────────│◄──────────────│
  │                  │                  │               │
  │                  │─linkDraftToNote()►               │
  │                  │  (frontmatter)   │               │
  │◄──Success────────│                  │               │
```

### 4.3 Styles CSS additionnels

```css
/* styles.css - Ajouts v1.3 */

/* Mode selector */
.substack-mode-container {
  margin-bottom: 1rem;
  padding: 1rem;
  background: var(--background-secondary);
  border-radius: 4px;
}

.substack-mode-container input[type="radio"] {
  margin-right: 0.5rem;
}

.substack-mode-container label {
  margin-right: 1.5rem;
}

.substack-draft-selector {
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 1px solid var(--background-modifier-border);
}

/* Draft list modal */
.substack-draft-list-modal {
  max-width: 600px;
}

.substack-draft-list {
  max-height: 400px;
  overflow-y: auto;
}

.substack-draft-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  border-bottom: 1px solid var(--background-modifier-border);
}

.substack-draft-item:hover {
  background: var(--background-secondary);
}

.substack-draft-info {
  flex: 1;
}

.substack-draft-title {
  font-weight: 500;
}

.substack-draft-subtitle {
  font-size: 0.9em;
  color: var(--text-muted);
}

.substack-draft-date {
  font-size: 0.8em;
  color: var(--text-faint);
}

.substack-draft-actions {
  display: flex;
  gap: 0.5rem;
}

.substack-draft-actions button {
  padding: 4px 8px;
  font-size: 0.85em;
}

.substack-danger-button {
  color: var(--text-error);
  border-color: var(--text-error);
}

.substack-no-drafts {
  text-align: center;
  color: var(--text-muted);
  padding: 2rem;
}
```

---

## 5. Plan d'implémentation

### 5.1 Tâches

| # | Tâche | Estimation | Dépendances |
|---|-------|------------|-------------|
| 1 | Ajouter méthodes API (listDrafts, updateDraft, deleteDraft) | 1h | - |
| 2 | Créer `DraftManager.ts` | 2h | 1 |
| 3 | Créer `DraftListModal.ts` | 2h | - |
| 4 | Implémenter gestion frontmatter (link) | 2h | 2 |
| 5 | Modifier PostComposer - mode selector | 1.5h | 2, 3 |
| 6 | Intégrer update flow dans PostComposer | 1.5h | 5 |
| 7 | Implémenter delete avec confirmation | 1h | 3 |
| 8 | Styles CSS | 1h | 3, 5 |
| 9 | Tests manuels | 1.5h | tout |

**Total estimé**: ~14h

### 5.2 Fichiers à créer/modifier

**Nouveaux fichiers**:
- `src/substack/draftManager.ts`
- `src/substack/DraftListModal.ts`

**Fichiers modifiés**:
- `src/substack/api.ts` - Ajouter méthodes
- `src/substack/types.ts` - Ajouter interfaces
- `src/substack/PostComposer.ts` - Mode selector + update flow
- `styles.css`

---

## 6. Risques et Mitigations

| Risque | Impact | Probabilité | Mitigation |
|--------|--------|-------------|------------|
| Perte de contenu sur update | Haut | Faible | Confirmation avant écrasement |
| Frontmatter corrompu | Moyen | Faible | Parser robuste, backup |
| Sync conflict (note modifiée ailleurs) | Moyen | Moyen | Warning si last_sync ancien |
| Delete accidentel | Haut | Moyen | Double confirmation |

---

## 7. Critères d'acceptance

- [ ] Liste des drafts affichée correctement
- [ ] Sélection d'un draft pour update
- [ ] Update d'un draft existant fonctionne
- [ ] Suppression avec confirmation
- [ ] Liaison frontmatter ↔ draft
- [ ] Détection auto si draft lié existe
- [ ] Open in browser fonctionne
- [ ] Gestion erreurs (draft supprimé ailleurs, etc.)

---

## 8. Références

- [Obsidian MetadataCache](https://docs.obsidian.md/Reference/TypeScript+API/MetadataCache) - Lecture frontmatter
- [Obsidian Vault.modify](https://docs.obsidian.md/Reference/TypeScript+API/Vault/modify) - Écriture fichier
- [YAML frontmatter spec](https://jekyllrb.com/docs/front-matter/)
