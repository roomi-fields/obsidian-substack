# Étude v1.1.0 - Support des Images

**Version**: 1.1.0
**Priorité**: HAUTE
**Statut**: À développer

---

## 1. Contexte et Objectifs

### 1.1 Problème
La v1.0 ne supporte que les images via URL externe. Les utilisateurs Obsidian ont généralement des images locales dans leur vault qu'ils souhaitent publier avec leurs articles.

### 1.2 Objectifs
- Permettre l'upload d'images locales vers le CDN Substack
- Conversion automatique des chemins locaux en URLs Substack
- Support des images de couverture (cover image)
- Expérience transparente pour l'utilisateur

### 1.3 Critères de succès
- Images locales uploadées et affichées correctement sur Substack
- Temps d'upload < 5s par image (connexion standard)
- Gestion des erreurs claire (fichier introuvable, format non supporté)

---

## 2. Analyse Fonctionnelle (BRD)

### 2.1 User Stories

| ID | Story | Priorité |
|----|-------|----------|
| US-1 | En tant qu'auteur, je veux que mes images locales `![alt](image.png)` soient automatiquement uploadées | MUST |
| US-2 | En tant qu'auteur, je veux voir la progression de l'upload des images | SHOULD |
| US-3 | En tant qu'auteur, je veux pouvoir définir une image de couverture | SHOULD |
| US-4 | En tant qu'auteur, je veux être averti si une image n'a pas pu être uploadée | MUST |
| US-5 | En tant qu'auteur, je veux que les images déjà sur le web (http/https) restent inchangées | MUST |

### 2.2 Formats supportés
- **Obligatoires**: PNG, JPG/JPEG, GIF, WebP
- **Taille max**: 10 MB (limite Substack)
- **Résolution max**: 4096x4096 px (recommandé)

### 2.3 Types de chemins à gérer
```markdown
# Chemins relatifs (Obsidian standard)
![alt](image.png)
![alt](./images/photo.jpg)
![alt](../assets/diagram.png)

# Chemins absolus vault
![alt](/attachments/image.png)

# URLs (ne pas modifier)
![alt](https://example.com/image.png)

# Wikilinks Obsidian (optionnel v1.1)
![[image.png]]
```

### 2.4 Cover Image
- Définie via frontmatter YAML : `cover: image.png`
- Ou première image du document (option dans settings)
- Uploadée séparément et attachée au post

---

## 3. Spécifications Techniques (CPD)

### 3.1 API Substack - Upload Image

**Endpoint**: `POST https://{publication}.substack.com/api/v1/images`

**Headers**:
```
Content-Type: multipart/form-data
Cookie: {session_cookie}
```

**Body** (multipart):
```
file: <binary image data>
```

**Response** (200 OK):
```json
{
  "id": "abc123",
  "url": "https://substackcdn.com/image/fetch/...",
  "contentType": "image/png",
  "bytes": 123456,
  "imageWidth": 800,
  "imageHeight": 600
}
```

### 3.2 Flux de traitement

```
┌─────────────────┐
│ Markdown Input  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Parse Images    │ ─── Extraire tous les ![alt](path)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Filter Local    │ ─── Séparer URLs vs chemins locaux
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Resolve Paths   │ ─── Convertir en chemins absolus
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Upload Images   │ ─── POST vers Substack CDN
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Replace URLs    │ ─── Remplacer chemins par URLs CDN
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Convert & Post  │ ─── Pipeline existant
└─────────────────┘
```

### 3.3 Nouvelles interfaces TypeScript

```typescript
// src/substack/types.ts

export interface ImageUploadResult {
  id: string;
  url: string;
  contentType: string;
  bytes: number;
  width: number;
  height: number;
  originalPath: string;
}

export interface ImageUploadError {
  path: string;
  error: string;
}

export interface ImageProcessingResult {
  success: ImageUploadResult[];
  errors: ImageUploadError[];
  markdown: string; // Markdown avec URLs remplacées
}
```

### 3.4 Nouvelle classe ImageHandler

```typescript
// src/substack/imageHandler.ts

export class ImageHandler {
  private api: SubstackAPI;
  private vault: Vault;

  constructor(api: SubstackAPI, vault: Vault);

  // Upload une image locale
  async uploadImage(
    publication: string,
    filePath: string
  ): Promise<ImageUploadResult>;

  // Traite tout le markdown et upload les images
  async processMarkdownImages(
    publication: string,
    markdown: string,
    basePath: string
  ): Promise<ImageProcessingResult>;

  // Résout un chemin relatif en chemin absolu vault
  resolveImagePath(
    imagePath: string,
    basePath: string
  ): string | null;

  // Vérifie si le format est supporté
  isValidFormat(filePath: string): boolean;
}
```

### 3.5 Modifications API existante

```typescript
// src/substack/api.ts - Ajouter méthode

async uploadImage(
  publication: string,
  imageData: ArrayBuffer,
  filename: string
): Promise<RequestUrlResponse> {
  // Utiliser requestUrl avec multipart/form-data
  // Note: Obsidian requestUrl supporte les uploads binaires
}
```

---

## 4. Architecture Logicielle

### 4.1 Diagramme de composants

```
┌──────────────────────────────────────────────────────────┐
│                    PostComposer.ts                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                  onPublish()                         │ │
│  │  1. getMarkdownContent()                            │ │
│  │  2. imageHandler.processMarkdownImages() ◄── NEW    │ │
│  │  3. converter.convert(processedMarkdown)            │ │
│  │  4. api.createDraft()                               │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
                           │
                           ▼
┌──────────────────────────────────────────────────────────┐
│                   ImageHandler.ts (NEW)                   │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ processMarkdownImages(markdown, basePath)           │ │
│  │   - parseImageReferences()                          │ │
│  │   - filterLocalImages()                             │ │
│  │   - uploadImages() ──────────────────────┐          │ │
│  │   - replacePathsWithUrls()               │          │ │
│  └──────────────────────────────────────────│──────────┘ │
└─────────────────────────────────────────────│────────────┘
                                              │
                                              ▼
┌──────────────────────────────────────────────────────────┐
│                     SubstackAPI.ts                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ uploadImage(publication, imageData, filename)       │ │
│  │   POST /api/v1/images                               │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
```

### 4.2 Séquence d'upload

```
User          PostComposer      ImageHandler       API          Substack
  │                │                 │              │               │
  │──Publish──────►│                 │              │               │
  │                │                 │              │               │
  │                │──processImages─►│              │               │
  │                │                 │──upload(img1)────────────────►│
  │                │                 │◄─────────url1─────────────────│
  │                │                 │──upload(img2)────────────────►│
  │                │                 │◄─────────url2─────────────────│
  │                │◄──result────────│              │               │
  │                │                 │              │               │
  │                │──createDraft(md with urls)────►│               │
  │                │                 │              │──POST /drafts─►│
  │                │◄────────────────────────────────────────────────│
  │◄──Success──────│                 │              │               │
```

### 4.3 Gestion des erreurs

| Erreur | Comportement | Message utilisateur |
|--------|--------------|---------------------|
| Fichier introuvable | Skip image, warning | "Image not found: {path}" |
| Format non supporté | Skip image, warning | "Unsupported format: {ext}" |
| Fichier trop gros | Skip image, error | "Image too large (max 10MB): {path}" |
| Upload échoué | Retry 1x, puis skip | "Failed to upload: {path}" |
| Tous uploads échoués | Proposer continuer sans images | "No images uploaded. Continue anyway?" |

### 4.4 Cache d'images (optionnel v1.1)

Pour éviter de re-uploader les mêmes images :
```typescript
interface ImageCache {
  [localPath: string]: {
    hash: string;      // MD5 du fichier
    url: string;       // URL Substack
    uploadedAt: Date;
  }
}
```
Stocké dans `data.json` du plugin.

---

## 5. Plan d'implémentation

### 5.1 Tâches

| # | Tâche | Estimation | Dépendances |
|---|-------|------------|-------------|
| 1 | Créer `ImageHandler.ts` avec parsing | 2h | - |
| 2 | Implémenter `api.uploadImage()` | 1h | - |
| 3 | Implémenter `resolveImagePath()` | 1h | 1 |
| 4 | Implémenter `uploadImage()` | 1h | 1, 2 |
| 5 | Implémenter `processMarkdownImages()` | 2h | 3, 4 |
| 6 | Intégrer dans `PostComposer.ts` | 1h | 5 |
| 7 | Ajouter indicateur de progression | 1h | 6 |
| 8 | Gestion cover image | 2h | 5 |
| 9 | Tests unitaires | 2h | 5 |
| 10 | Tests manuels | 1h | 6 |

**Total estimé**: ~14h

### 5.2 Fichiers à créer/modifier

**Nouveaux fichiers**:
- `src/substack/imageHandler.ts`

**Fichiers modifiés**:
- `src/substack/api.ts` - Ajouter `uploadImage()`
- `src/substack/types.ts` - Ajouter interfaces images
- `src/substack/PostComposer.ts` - Intégrer ImageHandler
- `styles.css` - Styles pour progress bar (optionnel)

---

## 6. Risques et Mitigations

| Risque | Impact | Probabilité | Mitigation |
|--------|--------|-------------|------------|
| API Substack change | Haut | Faible | Versionner API, tests réguliers |
| Rate limiting uploads | Moyen | Moyen | Upload séquentiel, délai entre uploads |
| Images très grandes | Moyen | Moyen | Validation taille avant upload |
| Chemins Windows vs Unix | Faible | Moyen | Normaliser paths avec `path.normalize()` |

---

## 7. Critères d'acceptance

- [ ] Images locales PNG/JPG/GIF/WebP uploadées vers Substack
- [ ] URLs remplacées dans le markdown avant conversion
- [ ] Images web (http/https) non modifiées
- [ ] Message d'erreur clair si image introuvable
- [ ] Message d'erreur clair si format non supporté
- [ ] Post créé même si certaines images échouent (avec warning)
- [ ] Cover image optionnelle depuis frontmatter

---

## 8. Références

- [substack-mcp-plus image_handler.py](../../../) - Implémentation Python de référence
- [Obsidian Vault API](https://docs.obsidian.md/Reference/TypeScript+API/Vault) - Accès aux fichiers
- [requestUrl](https://docs.obsidian.md/Reference/TypeScript+API/requestUrl) - Requêtes HTTP Obsidian
